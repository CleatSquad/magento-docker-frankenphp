#!/bin/bash
set -e

############################################
# Setup script for Magento Docker environment
# This script prepares the development environment by:
# - Creating the required Docker network
# - Copying environment file templates
# - Setting up user permissions
############################################

# Always run from the project root
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

echo "üöÄ Setting up Magento Docker environment..."

############################################
# 1) Create Docker network if needed
############################################
create_docker_network() {
    local network_name="proxy"

    if ! docker network ls --format '{{.Name}}' | grep -q "^${network_name}$"; then
        echo "üì° Creating ${network_name} network..."
        if docker network create "${network_name}"; then
            echo "‚úÖ Network '${network_name}' created"
        else
            echo "‚ùå ERROR: Failed to create Docker network '${network_name}'"
            exit 1
        fi
    else
        echo "‚úÖ Network '${network_name}' already exists"
    fi
}

create_docker_network

############################################
# 2) Prepare environment files
############################################
echo "üìù Setting up environment files..."

# Ensure env directory exists
if [ ! -d "env" ]; then
    echo "‚ùå ERROR: The 'env' directory does not exist!"
    echo "   Please ensure you are running this script from the project root."
    exit 1
fi

# Helper function to copy env file if it doesn't exist
copy_env_file() {
    local source_file="$1"
    local target_file="$2"
    local display_name="$3"

    if [ ! -f "${target_file}" ] && [ -f "${source_file}" ]; then
        if cp "${source_file}" "${target_file}"; then
            echo "‚úÖ Created ${display_name}"
        else
            echo "‚ö†Ô∏è  WARNING: Failed to create ${display_name}"
        fi
    elif [ -f "${target_file}" ]; then
        echo "‚ÑπÔ∏è  ${display_name} already exists, skipping..."
    fi
}

# Copy environment files from templates
copy_env_file "env/magento.env.example" ".env" ".env"
copy_env_file "env/mariadb.env.example" "env/mariadb.env" "env/mariadb.env"
copy_env_file "env/opensearch.env.example" "env/opensearch.env" "env/opensearch.env"
copy_env_file "env/rabbitmq.env.example" "env/rabbitmq.env" "env/rabbitmq.env"
copy_env_file "env/valkey.env.example" "env/valkey.env" "env/valkey.env"

############################################
# 3) Append USER_ID and GROUP_ID to .env
############################################
echo "üë§ Setting up user permissions..."

# Ensure .env file exists before appending
if [ ! -f ".env" ]; then
    touch .env
fi

# Add USER_ID if not present
if ! grep -q "^USER_ID=" .env; then
    echo "USER_ID=$(id -u)" >> .env
fi

# Add GROUP_ID if not present
if ! grep -q "^GROUP_ID=" .env; then
    echo "GROUP_ID=$(id -g)" >> .env
fi

echo "‚úÖ USER_ID=$(id -u), GROUP_ID=$(id -g) configured in .env"

# --- SSL setup: use SERVER_NAME from .env to call bin/setup-ssl ---
# Extract SERVER_NAME safely (strip surrounding quotes and whitespace)
SERVER_NAME=""
if [ -f ".env" ] && grep -q '^SERVER_NAME=' .env; then
    SERVER_NAME=$(grep -m1 -E '^SERVER_NAME=' .env | cut -d'=' -f2- | sed -e 's/^[[:space:]]*["'"'"']\{0,1\}//' -e 's/["'"'"']\{0,1\}[[:space:]]*$//' | xargs)
fi

if [ -n "${SERVER_NAME}" ]; then
    echo "üîê Setting up SSL for ${SERVER_NAME}..."
    if [ -x "bin/setup-ssl" ]; then
        if bin/setup-ssl "${SERVER_NAME}"; then
            echo "‚úÖ SSL setup completed for ${SERVER_NAME}"
        else
            echo "‚ö†Ô∏è  ERROR: SSL setup failed for ${SERVER_NAME}"
        fi
    elif [ -f "bin/setup-ssl" ]; then
        echo "‚ö†Ô∏è  bin/setup-ssl is not executable, running with bash..."
        if bash bin/setup-ssl "${SERVER_NAME}"; then
            echo "‚úÖ SSL setup completed for ${SERVER_NAME}"
        else
            echo "‚ö†Ô∏è  ERROR: SSL setup failed for ${SERVER_NAME}"
        fi
    else
        echo "‚ÑπÔ∏è  bin/setup-ssl not found, skipping SSL setup"
    fi
else
    echo "‚ÑπÔ∏è  SERVER_NAME not set in .env, skipping SSL setup"
fi
# --- end SSL setup ---

############################################
# 4) Summary and next steps
############################################
echo ""
echo "üéâ Setup complete!"
echo ""
echo "Next steps:"
echo "  docker compose up -d                              # Start development environment"
echo "  docker compose -f docker-compose.prod.yml up -d   # Start production environment"
echo ""
echo "For more information, see README.md"
