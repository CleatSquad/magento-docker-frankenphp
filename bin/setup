#!/bin/bash
set -e

############################################
# Setup script for Magento Docker environment
# This script prepares the development environment by:
# - Creating the required Docker network
# - Copying environment file templates
# - Setting up user permissions
############################################

# Always run from the project root
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

echo "ðŸš€ Setting up Magento Docker environment..."

############################################
# 1) Create Docker network if needed
############################################
create_docker_network() {
    local network_name="proxy"

    if ! docker network ls --format '{{.Name}}' | grep -q "^${network_name}$"; then
        echo "ðŸ“¡ Creating ${network_name} network..."
        if docker network create "${network_name}"; then
            echo "âœ… Network '${network_name}' created"
        else
            echo "âŒ ERROR: Failed to create Docker network '${network_name}'"
            exit 1
        fi
    else
        echo "âœ… Network '${network_name}' already exists"
    fi
}

create_docker_network

############################################
# 2) Prepare environment files
############################################
echo "ðŸ“ Setting up environment files..."

# Ensure env directory exists
if [ ! -d "env" ]; then
    echo "âŒ ERROR: The 'env' directory does not exist!"
    echo "   Please ensure you are running this script from the project root."
    exit 1
fi

# Helper function to copy env file if it doesn't exist
copy_env_file() {
    local source_file="$1"
    local target_file="$2"
    local display_name="$3"

    if [ ! -f "${target_file}" ] && [ -f "${source_file}" ]; then
        if cp "${source_file}" "${target_file}"; then
            echo "âœ… Created ${display_name}"
        else
            echo "âš ï¸  WARNING: Failed to create ${display_name}"
        fi
    elif [ -f "${target_file}" ]; then
        echo "â„¹ï¸  ${display_name} already exists, skipping..."
    fi
}

# Copy environment files from templates
copy_env_file "env/magento.env.example" ".env" ".env"
copy_env_file "env/mariadb.env.example" "env/mariadb.env" "env/mariadb.env"
copy_env_file "env/opensearch.env.example" "env/opensearch.env" "env/opensearch.env"
copy_env_file "env/rabbitmq.env.example" "env/rabbitmq.env" "env/rabbitmq.env"
copy_env_file "env/valkey.env.example" "env/valkey.env" "env/valkey.env"

############################################
# 3) Append USER_ID and GROUP_ID to .env
############################################
echo "ðŸ‘¤ Setting up user permissions..."

# Ensure .env file exists before appending
if [ ! -f ".env" ]; then
    touch .env
fi

# Add USER_ID if not present
if ! grep -q "^USER_ID=" .env; then
    echo "USER_ID=$(id -u)" >> .env
fi

# Add GROUP_ID if not present
if ! grep -q "^GROUP_ID=" .env; then
    echo "GROUP_ID=$(id -g)" >> .env
fi

echo "âœ… USER_ID=$(id -u), GROUP_ID=$(id -g) configured in .env"

############################################
# 4) Summary and next steps
############################################
echo ""
echo "ðŸŽ‰ Setup complete!"
echo ""
echo "Next steps:"
echo "  docker compose up -d                              # Start development environment"
echo "  docker compose -f docker-compose.prod.yml up -d   # Start production environment"
echo ""
echo "For more information, see README.md"
