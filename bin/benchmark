#!/bin/bash
#
# Benchmark script for comparing FrankenPHP vs Nginx + PHP-FPM
#
# Usage: ./bin/benchmark [options]
#   -c, --concurrency  Number of concurrent requests (default: 10)
#   -n, --requests     Total number of requests (default: 1000)
#   -w, --warmup       Number of warmup requests (default: 100)
#   -h, --help         Show this help message
#
# Requirements: curl, docker, docker compose
#
# This script will:
# 1. Start Nginx + PHP-FPM stack on port 8080
# 2. Start FrankenPHP stack on port 8081
# 3. Run benchmark tests using Apache Bench (ab)
# 4. Display comparative results

set -e

# Default values
CONCURRENCY=10
REQUESTS=1000
WARMUP=100
BENCHMARK_DIR="$(dirname "$(dirname "$(readlink -f "$0")")")/benchmark"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Print colored message
print_header() {
    echo -e "\n${PURPLE}═══════════════════════════════════════════════════════════════${NC}"
    echo -e "${PURPLE}  $1${NC}"
    echo -e "${PURPLE}═══════════════════════════════════════════════════════════════${NC}\n"
}

print_subheader() {
    echo -e "\n${CYAN}───────────────────────────────────────────────────────────────${NC}"
    echo -e "${CYAN}  $1${NC}"
    echo -e "${CYAN}───────────────────────────────────────────────────────────────${NC}\n"
}

print_info() {
    echo -e "${BLUE}ℹ ${NC} $1"
}

print_success() {
    echo -e "${GREEN}✓ ${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠ ${NC} $1"
}

print_error() {
    echo -e "${RED}✗ ${NC} $1"
}

# Show help
show_help() {
    echo "Benchmark: FrankenPHP vs Nginx + PHP-FPM"
    echo ""
    echo "Usage: $0 [options]"
    echo ""
    echo "Options:"
    echo "  -c, --concurrency  Number of concurrent requests (default: $CONCURRENCY)"
    echo "  -n, --requests     Total number of requests (default: $REQUESTS)"
    echo "  -w, --warmup       Number of warmup requests (default: $WARMUP)"
    echo "  -h, --help         Show this help message"
    echo ""
    echo "Examples:"
    echo "  $0                     # Run with defaults"
    echo "  $0 -c 50 -n 5000       # 50 concurrent, 5000 total requests"
    echo "  $0 --concurrency 100   # 100 concurrent requests"
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -c|--concurrency)
            CONCURRENCY="$2"
            shift 2
            ;;
        -n|--requests)
            REQUESTS="$2"
            shift 2
            ;;
        -w|--warmup)
            WARMUP="$2"
            shift 2
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            print_error "Unknown option: $1"
            show_help
            exit 1
            ;;
    esac
done

# Check dependencies
check_dependencies() {
    print_subheader "Checking dependencies"
    
    local missing=0
    
    if command -v docker &> /dev/null; then
        print_success "Docker found"
    else
        print_error "Docker not found"
        missing=1
    fi
    
    if docker compose version &> /dev/null; then
        print_success "Docker Compose found"
    else
        print_error "Docker Compose not found"
        missing=1
    fi
    
    if command -v curl &> /dev/null; then
        print_success "curl found"
    else
        print_error "curl not found"
        missing=1
    fi
    
    # Check for ab (Apache Bench)
    if command -v ab &> /dev/null; then
        print_success "Apache Bench (ab) found"
        AB_CMD="ab"
    elif docker run --rm httpd:alpine ab -V &> /dev/null; then
        print_success "Apache Bench (ab) available via Docker"
        AB_CMD="docker run --rm --network host httpd:alpine ab"
    else
        print_warning "Apache Bench not found, installing via Docker..."
        AB_CMD="docker run --rm --network host httpd:alpine ab"
    fi
    
    if [ $missing -eq 1 ]; then
        print_error "Missing dependencies. Please install them and try again."
        exit 1
    fi
}

# Start services
start_services() {
    print_subheader "Starting benchmark services"
    
    cd "$BENCHMARK_DIR"
    
    print_info "Starting Nginx + PHP-FPM stack..."
    docker compose -p benchmark-nginx -f docker-compose.nginx.yml up -d
    
    print_info "Starting FrankenPHP stack..."
    docker compose -p benchmark-frankenphp -f docker-compose.frankenphp.yml up -d
    
    print_info "Waiting for services to be ready..."
    sleep 5
    
    # Wait for Nginx + PHP-FPM
    local retries=30
    while ! curl -s http://localhost:8080/health.php > /dev/null && [ $retries -gt 0 ]; do
        sleep 1
        retries=$((retries - 1))
    done
    
    if [ $retries -eq 0 ]; then
        print_error "Nginx + PHP-FPM failed to start"
        stop_services
        exit 1
    fi
    print_success "Nginx + PHP-FPM is ready (port 8080)"
    
    # Wait for FrankenPHP
    retries=30
    while ! curl -s http://localhost:8081/health.php > /dev/null && [ $retries -gt 0 ]; do
        sleep 1
        retries=$((retries - 1))
    done
    
    if [ $retries -eq 0 ]; then
        print_error "FrankenPHP failed to start"
        stop_services
        exit 1
    fi
    print_success "FrankenPHP is ready (port 8081)"
}

# Stop services
stop_services() {
    print_subheader "Stopping benchmark services"
    
    cd "$BENCHMARK_DIR"
    
    docker compose -p benchmark-nginx -f docker-compose.nginx.yml down --remove-orphans 2>/dev/null || true
    docker compose -p benchmark-frankenphp -f docker-compose.frankenphp.yml down --remove-orphans 2>/dev/null || true
    
    print_success "Services stopped"
}

# Run warmup
run_warmup() {
    local url=$1
    local name=$2
    
    print_info "Warming up $name with $WARMUP requests..."
    $AB_CMD -n "$WARMUP" -c 5 "$url" > /dev/null 2>&1 || true
}

# Run benchmark
run_benchmark() {
    local url=$1
    local name=$2
    local output_file=$3
    
    # Print info to stderr so it doesn't mix with results
    echo -e "${BLUE}ℹ ${NC} Benchmarking $name: $REQUESTS requests, $CONCURRENCY concurrent..." >&2
    
    # Run ab and capture output
    $AB_CMD -n "$REQUESTS" -c "$CONCURRENCY" -g "$output_file.tsv" "$url" > "$output_file.txt" 2>&1 || true
    
    # Extract key metrics
    local rps time_mean time_p50 time_p95 time_p99 failed
    rps=$(grep "Requests per second" "$output_file.txt" | awk '{print $4}')
    time_mean=$(grep "Time per request.*mean\)" "$output_file.txt" | head -1 | awk '{print $4}')
    time_p50=$(grep "50%" "$output_file.txt" | awk '{print $2}')
    time_p95=$(grep "95%" "$output_file.txt" | awk '{print $2}')
    time_p99=$(grep "99%" "$output_file.txt" | awk '{print $2}')
    failed=$(grep "Failed requests" "$output_file.txt" | awk '{print $3}')
    
    echo "$rps|$time_mean|$time_p50|$time_p95|$time_p99|$failed"
}

# Format number with color based on comparison
format_comparison() {
    local val1=$1
    local val2=$2
    local higher_is_better=$3
    
    # Check if values are empty or not numeric
    if [ -z "$val1" ] || [ -z "$val2" ]; then
        echo "N/A"
        return
    fi
    
    # Validate that values are numeric (allow decimals)
    if ! echo "$val1" | grep -qE '^[0-9]+\.?[0-9]*$' || ! echo "$val2" | grep -qE '^[0-9]+\.?[0-9]*$'; then
        echo "N/A"
        return
    fi
    
    # Check for division by zero
    if [ "$val2" = "0" ] || [ "$val2" = "0.0" ]; then
        echo "N/A"
        return
    fi
    
    # Use awk for better portability (bc may not be available everywhere)
    local diff
    diff=$(awk "BEGIN {printf \"%.2f\", (($val1 - $val2) / $val2) * 100}" 2>/dev/null)
    
    local is_val1_greater
    is_val1_greater=$(awk "BEGIN {print ($val1 > $val2) ? 1 : 0}" 2>/dev/null)
    
    # Check if awk succeeded
    if [ -z "$diff" ] || [ -z "$is_val1_greater" ]; then
        echo "N/A"
        return
    fi
    
    if [ "$higher_is_better" = "true" ]; then
        if [ "$is_val1_greater" = "1" ]; then
            echo -e "${GREEN}+${diff}%${NC}"
        else
            echo -e "${RED}${diff}%${NC}"
        fi
    else
        if [ "$is_val1_greater" = "0" ]; then
            echo -e "${GREEN}${diff}%${NC}"
        else
            echo -e "${RED}+${diff}%${NC}"
        fi
    fi
}

# Display results table
display_results() {
    local nginx_results=$1
    local frankenphp_results=$2
    
    # Parse results
    IFS='|' read -r nginx_rps nginx_mean nginx_p50 nginx_p95 nginx_p99 nginx_failed <<< "$nginx_results"
    IFS='|' read -r fp_rps fp_mean fp_p50 fp_p95 fp_p99 fp_failed <<< "$frankenphp_results"
    
    print_subheader "Benchmark Results"
    
    echo ""
    printf "%-25s %15s %15s %15s\n" "Metric" "Nginx+PHP-FPM" "FrankenPHP" "Difference"
    echo "─────────────────────────────────────────────────────────────────────"
    printf "%-25s %15s %15s " "Requests/sec" "$nginx_rps" "$fp_rps"
    format_comparison "$fp_rps" "$nginx_rps" "true"
    echo ""
    printf "%-25s %15s %15s " "Mean time (ms)" "$nginx_mean" "$fp_mean"
    format_comparison "$fp_mean" "$nginx_mean" "false"
    echo ""
    printf "%-25s %15s %15s " "50th percentile (ms)" "$nginx_p50" "$fp_p50"
    format_comparison "$fp_p50" "$nginx_p50" "false"
    echo ""
    printf "%-25s %15s %15s " "95th percentile (ms)" "$nginx_p95" "$fp_p95"
    format_comparison "$fp_p95" "$nginx_p95" "false"
    echo ""
    printf "%-25s %15s %15s " "99th percentile (ms)" "$nginx_p99" "$fp_p99"
    format_comparison "$fp_p99" "$nginx_p99" "false"
    echo ""
    printf "%-25s %15s %15s\n" "Failed requests" "$nginx_failed" "$fp_failed"
    echo ""
}

# Cleanup function
cleanup() {
    print_info "Cleaning up..."
    stop_services
    rm -f /tmp/benchmark_*.txt /tmp/benchmark_*.tsv 2>/dev/null || true
}

# Set trap for cleanup
trap cleanup EXIT

# Main execution
main() {
    print_header "Benchmark: FrankenPHP vs Nginx + PHP-FPM"
    
    echo ""
    print_info "Configuration:"
    echo "  • Concurrent requests: $CONCURRENCY"
    echo "  • Total requests: $REQUESTS"
    echo "  • Warmup requests: $WARMUP"
    echo ""
    
    check_dependencies
    start_services
    
    print_subheader "Running benchmarks"
    
    # Warmup
    run_warmup "http://localhost:8080/index.php" "Nginx + PHP-FPM"
    run_warmup "http://localhost:8081/index.php" "FrankenPHP"
    
    # Run benchmarks
    nginx_results=$(run_benchmark "http://localhost:8080/index.php" "Nginx + PHP-FPM" "/tmp/benchmark_nginx")
    frankenphp_results=$(run_benchmark "http://localhost:8081/index.php" "FrankenPHP" "/tmp/benchmark_frankenphp")
    
    # Display results
    display_results "$nginx_results" "$frankenphp_results"
    
    print_subheader "Summary"
    
    # Parse for summary
    IFS='|' read -r nginx_rps _ _ _ _ _ <<< "$nginx_results"
    IFS='|' read -r fp_rps _ _ _ _ _ <<< "$frankenphp_results"
    
    # Validate values are numeric before comparison
    if [ -n "$nginx_rps" ] && [ -n "$fp_rps" ] && \
       echo "$nginx_rps" | grep -qE '^[0-9]+\.?[0-9]*$' && \
       echo "$fp_rps" | grep -qE '^[0-9]+\.?[0-9]*$'; then
        local improvement difference is_fp_faster
        is_fp_faster=$(awk "BEGIN {print ($fp_rps > $nginx_rps) ? 1 : 0}" 2>/dev/null)
        if [ "$is_fp_faster" = "1" ]; then
            improvement=$(awk "BEGIN {printf \"%.1f\", (($fp_rps - $nginx_rps) / $nginx_rps) * 100}" 2>/dev/null)
            print_success "FrankenPHP is ${GREEN}${improvement}%${NC} faster than Nginx + PHP-FPM"
        else
            difference=$(awk "BEGIN {printf \"%.1f\", (($nginx_rps - $fp_rps) / $fp_rps) * 100}" 2>/dev/null)
            print_info "Nginx + PHP-FPM is ${difference}% faster in this test"
        fi
    else
        print_warning "Could not calculate performance comparison (invalid metrics)"
    fi
    
    echo ""
    print_info "Detailed results saved to:"
    echo "  • /tmp/benchmark_nginx.txt"
    echo "  • /tmp/benchmark_frankenphp.txt"
    echo ""
    
    print_success "Benchmark completed!"
}

main
