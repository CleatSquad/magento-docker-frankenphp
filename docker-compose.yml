services:
  traefik:
    image: traefik:v3.6
    restart: unless-stopped
    container_name: ${PROJECT_NAME:-magento}-traefik
    profiles:
      - dev
    security_opt:
      - no-new-privileges:true
    command:
      - --configFile=/traefik.yml
    networks:
      - magento
      - proxy
    ports:
      - 80:80
      - 443:443
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./conf/traefik.yml:/traefik.yml:ro
      - ./conf/dynamic:/etc/traefik/dynamic
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.traefik.entrypoints=http
      - traefik.http.routers.traefik.rule=Host(`traefik.localhost`)
      - traefik.http.routers.traefik.service=api@internal

  app:
    image: mohelmrabet/magento-frankenphp:php8.4-fp1.10.1-dev
    container_name: ${PROJECT_NAME:-magento}-app
    user: www-data
    profiles:
      - dev
    environment:
      SERVER_NAME: ${SERVER_NAME:-magento.localhost}
      USER_ID: ${USER_ID:-1000}
      GROUP_ID: ${GROUP_ID:-1000}
      MAGENTO_RUN_MODE: developer
      # Xdebug configuration
      XDEBUG_MODE: ${XDEBUG_MODE:-debug}
      XDEBUG_CLIENT_HOST: ${XDEBUG_CLIENT_HOST:-host.docker.internal}
      XDEBUG_CLIENT_PORT: ${XDEBUG_CLIENT_PORT:-9003}
      XDEBUG_START_WITH_REQUEST: ${XDEBUG_START_WITH_REQUEST:-trigger}
      XDEBUG_IDEKEY: ${XDEBUG_IDEKEY:-PHPSTORM}
      # Use trusted SSL certificates generated by bin/setup-ssl (optional):
      # CADDY_TLS_CONFIG: "/etc/caddy/ssl/magento.localhost.pem /etc/caddy/ssl/magento.localhost-key.pem"
      SENDMAIL_PATH: "/usr/local/bin/mhsendmail --smtp-addr=magento-mailhog:1025"
    volumes:
      # Custom Caddyfile template (optional - mount your own to customize)
      # - ./conf/Caddyfile.template:/etc/caddy/Caddyfile.template:ro
      # Mount SSL certificates generated by bin/setup-ssl (optional)
      # - ./conf/ssl:/etc/caddy/ssl:ro
      - ./src:/var/www/html
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:2019/config/", "-o", "/dev/null", "-s"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.magento-http.rule=Host(`${SERVER_NAME:-magento.localhost}`)
      - traefik.http.routers.magento-http.entrypoints=http
      - traefik.http.routers.magento-http.middlewares=redirect-to-https
      - traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https
      - traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true
      - traefik.tcp.routers.magento.rule=HostSNI(`${SERVER_NAME:-magento.localhost}`)
      - traefik.tcp.routers.magento.entrypoints=https
      - traefik.tcp.routers.magento.tls.passthrough=true
      - traefik.tcp.services.magento.loadbalancer.server.port=443
    depends_on:
      mariadb:
        condition: service_healthy
      opensearch:
        condition: service_healthy
      valkey:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - magento
      - proxy

  mariadb:
    image: mariadb:11.4
    container_name: ${PROJECT_NAME:-magento}-db
    profiles:
      - dev
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
      MYSQL_DATABASE: ${DB_NAME:-magento}
      MYSQL_USER: ${DB_USER:-magento}
      MYSQL_PASSWORD: ${DB_PASSWORD:-magento}
    volumes:
      - db-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - magento

  opensearch:
    build:
      context: ./images/opensearch
      dockerfile: Dockerfile
    container_name: ${PROJECT_NAME:-magento}-opensearch
    profiles:
      - dev
    networks:
      - magento
      - proxy
    env_file: env/opensearch.env
    environment:
      - "discovery.type=single-node"
      - "cluster.routing.allocation.disk.threshold_enabled=false"
      - "index.blocks.read_only_allow_delete"
    volumes:
      - opensearch-data:/usr/share/opensearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  valkey:
    image: valkey/valkey:8.1.4
    container_name: ${PROJECT_NAME:-magento}-valkey
    profiles:
      - dev
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "valkey-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - magento
      - proxy

  rabbitmq:
    image: rabbitmq:4.1-management-alpine
    container_name: ${PROJECT_NAME:-magento}-rabbitmq
    profiles:
      - dev
    env_file: env/rabbitmq.env
    networks:
      - magento
      - proxy
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
      - ./images/rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.rabbit.entrypoints=http
      - traefik.http.routers.rabbit.rule=Host(`rabbit.localhost`)
      - traefik.http.services.rabbit.loadbalancer.server.port=15672

  mailhog:
    image: mailhog/mailhog
    container_name: ${PROJECT_NAME:-magento}-mailhog
    profiles:
      - dev
      - debug
    networks:
      - magento
      - proxy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8025"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.mailhog.entrypoints=http
      - traefik.http.routers.mailhog.rule=Host(`mailhog.localhost`)
      - traefik.http.services.mailhog.loadbalancer.server.port=8025

  phpmyadmin:
    image: phpmyadmin/phpmyadmin:latest
    container_name: ${PROJECT_NAME:-magento}-phpmyadmin
    profiles:
      - dev
      - debug
    networks:
      - magento
      - proxy
    env_file: env/mariadb.env
    depends_on:
      mariadb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80", "-o", "/dev/null", "-s"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.phpmyadmin.entrypoints=http
      - traefik.http.routers.phpmyadmin.rule=Host(`myadmin.localhost`)
      - traefik.http.services.phpmyadmin.loadbalancer.server.port=80
      - traefik.http.services.phpmyadmin.loadbalancer.server.scheme=http

networks:
  magento:
  proxy:
    external: true

volumes:
  db-data:
  opensearch-data:
  rabbitmq-data:
