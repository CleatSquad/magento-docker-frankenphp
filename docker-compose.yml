services:
  traefik:
    image: traefik:v3.6
    restart: unless-stopped
    container_name: ${PROJECT_NAME:-magento}-traefik
    security_opt:
      - no-new-privileges:true
    command:
      - --configFile=/traefik.yml
    networks:
      - magento
      - proxy
    ports:
      - 80:80
      - 443:443
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./conf/traefik.yml:/traefik.yml:ro
      - ./conf/dynamic:/etc/traefik/dynamic
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.traefik.entrypoints=http
      - traefik.http.routers.traefik.rule=Host(`traefik.localhost`)
      - traefik.http.routers.traefik.service=api@internal

  app:
    image: mohelmrabet/magento-frankenphp:php8.4-fp1.10.1-dev
    container_name: ${PROJECT_NAME:-magento}-app
    user: www-data
    environment:
      SERVER_NAME: ${SERVER_NAME:-magento.localhost}
      USER_ID: ${USER_ID:-1000}
      GROUP_ID: ${GROUP_ID:-1000}
      MAGENTO_RUN_MODE: developer
      # Xdebug configuration
      XDEBUG_MODE: ${XDEBUG_MODE:-debug}
      XDEBUG_CLIENT_HOST: ${XDEBUG_CLIENT_HOST:-host.docker.internal}
      XDEBUG_CLIENT_PORT: ${XDEBUG_CLIENT_PORT:-9003}
      XDEBUG_START_WITH_REQUEST: ${XDEBUG_START_WITH_REQUEST:-trigger}
      XDEBUG_IDEKEY: ${XDEBUG_IDEKEY:-PHPSTORM}
      # Use trusted SSL certificates generated by bin/setup-ssl (optional):
      # CADDY_TLS_CONFIG: "/etc/caddy/ssl/magento.localhost.pem /etc/caddy/ssl/magento.localhost-key.pem"
      SENDMAIL_PATH: "/usr/local/bin/mhsendmail --smtp-addr=magento-mailhog:1025"
    volumes:
      # Custom Caddyfile template (optional - mount your own to customize)
      # - ./conf/Caddyfile.template:/etc/caddy/Caddyfile.template:ro
      # Mount SSL certificates generated by bin/setup-ssl (optional)
      #- ./conf/ssl:/etc/caddy/ssl:ro
      - ./src:/var/www/html
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.magento-http.rule=Host(`${SERVER_NAME:-magento.localhost}`)
      - traefik.http.routers.magento-http.entrypoints=http
      - traefik.http.routers.magento-http.middlewares=redirect-to-https
      - traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https
      - traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true
      - traefik.tcp.routers.magento.rule=HostSNI(`${SERVER_NAME:-magento.localhost}`)
      - traefik.tcp.routers.magento.entrypoints=https
      - traefik.tcp.routers.magento.tls.passthrough=true
      - traefik.tcp.services.magento.loadbalancer.server.port=443
    depends_on:
      - mariadb
      - opensearch
      - valkey
      - rabbitmq
    networks:
      - magento
      - proxy

  mariadb:
    image: mariadb:11.4
    container_name: ${PROJECT_NAME:-magento}-db
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: magento
      MYSQL_USER: magento
      MYSQL_PASSWORD: magento
    volumes:
      - db-data:/var/lib/mysql
    networks:
      - magento

  opensearch:
    build:
      context: ./images/opensearch
      dockerfile: Dockerfile
    container_name: ${PROJECT_NAME:-magento}-opensearch
    networks:
      - magento
      - proxy
    env_file: env/opensearch.env
    environment:
      - "discovery.type=single-node"
      - "cluster.routing.allocation.disk.threshold_enabled=false"
      - "index.blocks.read_only_allow_delete"
    volumes:
      - opensearch-data:/usr/share/opensearch/data

  valkey:
    image: valkey/valkey:8.1.4
    container_name: ${PROJECT_NAME:-magento}-valkey
    ports:
      - "6379:6379"
    networks:
      - magento
      - proxy

  rabbitmq:
    image: rabbitmq:4.1-management-alpine
    container_name: ${PROJECT_NAME:-magento}-rabbitmq
    env_file: env/rabbitmq.env
    networks:
      - magento
      - proxy
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
      - ./images/rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.rabbit.entrypoints=http
      - traefik.http.routers.rabbit.rule=Host(`rabbit.localhost`)
      - traefik.http.services.rabbit.loadbalancer.server.port=15672

  mailhog:
    image: mailhog/mailhog
    container_name: ${PROJECT_NAME:-magento}-mailhog
    networks:
      - magento
      - proxy
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.mailhog.entrypoints=http
      - traefik.http.routers.mailhog.rule=Host(`mailhog.localhost`)
      - traefik.http.services.mailhog.loadbalancer.server.port=8025

  phpmyadmin:
    image: phpmyadmin/phpmyadmin:latest
    container_name: ${PROJECT_NAME:-magento}-phpmyadmin
    networks:
      - magento
      - proxy
    env_file: env/mariadb.env
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.phpmyadmin.entrypoints=http
      - traefik.http.routers.phpmyadmin.rule=Host(`myadmin.localhost`)
      - traefik.http.services.phpmyadmin.loadbalancer.server.port=80
      - traefik.http.services.phpmyadmin.loadbalancer.server.scheme=http

networks:
  magento:
  proxy:
    external: true

volumes:
  db-data:
  opensearch-data:
  rabbitmq-data:
