---
name: Generate Release Notes

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  generate-release-notes:
    name: Generate Release Notes
    runs-on: ubuntu-latest
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '@bot generate-release-note')
    steps:
      - name: Check if PR targets main branch
        id: check_target
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_DATA=$(gh api repos/${{ github.repository }}/pulls/${{ github.event.issue.number }})
          BASE_REF=$(echo "$PR_DATA" | jq -r '.base.ref')
          BASE_REPO=$(echo "$PR_DATA" | jq -r '.base.repo.full_name')

          # Check if PR targets main branch of the current repository
          if [ "$BASE_REF" != "main" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "reason=PR does not target main branch (targets: $BASE_REF)" >> "$GITHUB_OUTPUT"
          elif [ "$BASE_REPO" != "${{ github.repository }}" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "reason=PR does not target this repository" >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip if not targeting main
        if: steps.check_target.outputs.skip == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REASON: ${{ steps.check_target.outputs.reason }}
        run: |
          gh api repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions \
            -X POST -f content='confused'

          gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            -X POST -f body="âš ï¸ Release notes generation skipped: ${REASON}

          This command only works for PRs targeting the \`main\` branch of this repository."
          exit 0

      - name: Add reaction to comment
        if: steps.check_target.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions \
            -X POST -f content='eyes'

      - name: Get PR details
        if: steps.check_target.outputs.skip != 'true'
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_DATA=$(gh api repos/${{ github.repository }}/pulls/${{ github.event.issue.number }})
          echo "number=${{ github.event.issue.number }}" >> "$GITHUB_OUTPUT"
          echo "title=$(echo "$PR_DATA" | jq -r '.title')" >> "$GITHUB_OUTPUT"
          echo "head_ref=$(echo "$PR_DATA" | jq -r '.head.ref')" >> "$GITHUB_OUTPUT"
          echo "head_sha=$(echo "$PR_DATA" | jq -r '.head.sha')" >> "$GITHUB_OUTPUT"
          echo "base_ref=$(echo "$PR_DATA" | jq -r '.base.ref')" >> "$GITHUB_OUTPUT"
          HEAD_REPO=$(echo "$PR_DATA" | jq -r '.head.repo.full_name')
          BASE_REPO=$(echo "$PR_DATA" | jq -r '.base.repo.full_name')
          echo "head_repo=$HEAD_REPO" >> "$GITHUB_OUTPUT"
          # Check if this is a fork PR (head repo different from base repo)
          if [ "$HEAD_REPO" != "$BASE_REPO" ]; then
            echo "is_fork=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_fork=false" >> "$GITHUB_OUTPUT"
          fi
          # Store body in a file to handle multiline content
          echo "$PR_DATA" | jq -r '.body // ""' > /tmp/pr_body.txt

      - name: Checkout PR branch
        if: steps.check_target.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.issue.number }}/head
          fetch-depth: 0

      - name: Fetch base branch
        if: steps.check_target.outputs.skip != 'true'
        run: |
          # Fetch the base branch from origin
          git fetch origin ${{ steps.pr.outputs.base_ref }} 2>/dev/null || echo "Base branch fetch completed"

      - name: Get changed files
        if: steps.check_target.outputs.skip != 'true'
        id: changes
        run: |
          # Get list of changed files in PR (use origin/ prefix for remote branch)
          CHANGED_FILES=$(git diff --name-only origin/${{ steps.pr.outputs.base_ref }}...HEAD 2>/dev/null | head -50 || echo "")
          echo "files<<EOF" >> "$GITHUB_OUTPUT"
          echo "$CHANGED_FILES" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Get commit messages
        if: steps.check_target.outputs.skip != 'true'
        id: commits
        run: |
          # Get commit messages from PR (use origin/ prefix for remote branch)
          COMMITS=$(git log --oneline origin/${{ steps.pr.outputs.base_ref }}...HEAD 2>/dev/null | head -20 || echo "")
          echo "messages<<EOF" >> "$GITHUB_OUTPUT"
          echo "$COMMITS" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Check existing release notes
        if: steps.check_target.outputs.skip != 'true'
        id: existing
        run: |
          PR_NUMBER=${{ steps.pr.outputs.number }}
          NOTES_FILE=".release-notes/pr-${PR_NUMBER}.md"
          if [ -f "$NOTES_FILE" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            CONTENT=$(cat "$NOTES_FILE")
            echo "content<<EOF" >> "$GITHUB_OUTPUT"
            echo "$CONTENT" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "content=" >> "$GITHUB_OUTPUT"
          fi

      - name: Read PR body from file
        if: steps.check_target.outputs.skip != 'true'
        id: body
        run: |
          # Truncate at a safe boundary (use slightly less than 2000 to avoid mid-character cut)
          echo "content<<EOF" >> "$GITHUB_OUTPUT"
          cat /tmp/pr_body.txt | head -c 1900 >> "$GITHUB_OUTPUT"
          echo "" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Generate release notes
        if: steps.check_target.outputs.skip != 'true'
        id: generate
        run: |
          PR_TITLE="${{ steps.pr.outputs.title }}"
          CHANGED_FILES="${{ steps.changes.outputs.files }}"

          # Determine category based on title and files
          LOWER_TITLE=$(echo "$PR_TITLE" | tr '[:upper:]' '[:lower:]')
          LOWER_FILES=$(echo "$CHANGED_FILES" | tr '[:upper:]' '[:lower:]')

          CATEGORY="Changed"
          if echo "$LOWER_TITLE" | grep -qE 'fix|bug'; then
            CATEGORY="Fixed"
          elif echo "$LOWER_TITLE" | grep -qE 'feat|add'; then
            CATEGORY="Added"
          elif echo "$LOWER_TITLE" | grep -qE 'doc' || echo "$LOWER_FILES" | grep -qE '\.md|readme'; then
            CATEGORY="Documentation"
          elif echo "$LOWER_TITLE" | grep -qE 'security|vuln'; then
            CATEGORY="Security"
          elif echo "$LOWER_TITLE" | grep -qE 'deprecat'; then
            CATEGORY="Deprecated"
          elif echo "$LOWER_TITLE" | grep -qE 'remov|delet'; then
            CATEGORY="Removed"
          fi

          # Escape special characters in title for safe use
          SAFE_TITLE=$(printf '%s' "$PR_TITLE" | sed 's/[&/\]/\\&/g')

          # Generate release notes content
          NOTES="### ${CATEGORY}

          - ${SAFE_TITLE}"

          # Save to file for later use
          mkdir -p .release-notes
          PR_NUMBER=${{ steps.pr.outputs.number }}
          echo "$NOTES" > ".release-notes/pr-${PR_NUMBER}.md"

          # Output for workflow
          echo "category=$CATEGORY" >> "$GITHUB_OUTPUT"
          echo "notes<<EOF" >> "$GITHUB_OUTPUT"
          echo "$NOTES" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Commit and push (same-repo PRs only)
        id: push
        if: steps.check_target.outputs.skip != 'true' && steps.pr.outputs.is_fork == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          PR_NUMBER=${{ steps.pr.outputs.number }}
          NOTES_FILE=".release-notes/pr-${PR_NUMBER}.md"
          HEAD_REF="${{ steps.pr.outputs.head_ref }}"

          # Fetch the actual branch so we can push to it
          git fetch origin "$HEAD_REF":"$HEAD_REF" || true

          # Switch to the branch
          git checkout "$HEAD_REF"

          # Ensure directory exists and write the file
          mkdir -p .release-notes
          echo '${{ steps.generate.outputs.notes }}' > "$NOTES_FILE"

          git add "$NOTES_FILE"
          if git diff --staged --quiet; then
            echo "pushed=false" >> "$GITHUB_OUTPUT"
            echo "No changes to commit"
          else
            git commit -m "Generate release notes for PR #${PR_NUMBER}"
            git push origin "$HEAD_REF"
            echo "pushed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Add success reaction
        if: success() && steps.check_target.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions \
            -X POST -f content='rocket'
          gh api repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions \
            -X POST -f content='+1'

      - name: Comment on PR (fork PRs - manual instructions)
        if: steps.check_target.outputs.skip != 'true' && steps.pr.outputs.is_fork == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
          CATEGORY: ${{ steps.generate.outputs.category }}
          NOTES: ${{ steps.generate.outputs.notes }}
        run: |
          NOTES_FILE=".release-notes/pr-${PR_NUMBER}.md"

          BODY="### Release Notes Generated

          **Category detected:** ${CATEGORY}

          Since this PR is from a fork, I cannot push the file directly. Please create the file manually:

          **File:** \`${NOTES_FILE}\`

          <details>
          <summary>ðŸ“‹ Content (click to expand and copy)</summary>

          \`\`\`markdown
          ${NOTES}
          \`\`\`

          </details>

          The content will be automatically added to CHANGELOG.md when this PR is merged."

          gh api repos/${{ github.repository }}/issues/${PR_NUMBER}/comments \
            -X POST -f body="$BODY"

      - name: Comment on PR (same-repo PRs - file committed)
        if: steps.check_target.outputs.skip != 'true' && steps.pr.outputs.is_fork == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
          CATEGORY: ${{ steps.generate.outputs.category }}
          NOTES: ${{ steps.generate.outputs.notes }}
          PUSHED: ${{ steps.push.outputs.pushed }}
        run: |
          NOTES_FILE=".release-notes/pr-${PR_NUMBER}.md"

          if [ "$PUSHED" = "true" ]; then
            BODY="### Release Notes Generated âœ…

            I've created/updated the release notes file: \`${NOTES_FILE}\`

            **Category detected:** ${CATEGORY}

            Please review the file and make any necessary adjustments. The content will be automatically added to CHANGELOG.md when this PR is merged.

            <details>
            <summary>Preview</summary>

            \`\`\`markdown
            ${NOTES}
            \`\`\`

            </details>"
          else
            BODY="### Release Notes

            **Category detected:** ${CATEGORY}

            No changes were needed - the release notes file already exists with the same content.

            <details>
            <summary>Preview</summary>

            \`\`\`markdown
            ${NOTES}
            \`\`\`

            </details>"
          fi

          gh api repos/${{ github.repository }}/issues/${PR_NUMBER}/comments \
            -X POST -f body="$BODY"

      - name: Handle failure
        if: failure() && steps.check_target.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.issue.number }}
        run: |
          # Add failure reaction (ignore errors if comment was deleted)
          gh api repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions \
            -X POST -f content='-1' 2>/dev/null || echo "Could not add reaction (comment may have been deleted)"

          NOTES_FILE=".release-notes/pr-${PR_NUMBER}.md"

          BODY="### Release Notes Generation Failed

          I encountered an error while generating release notes. Please create the file manually:

          **File:** \`${NOTES_FILE}\`

          **Template:**
          \`\`\`markdown
          ### Changed

          - Description of your changes here
          \`\`\`

          **Categories you can use:**
          - \`### Added\` - New features
          - \`### Changed\` - Changes in existing functionality
          - \`### Deprecated\` - Soon-to-be removed features
          - \`### Removed\` - Now removed features
          - \`### Fixed\` - Bug fixes
          - \`### Security\` - Security fixes

          The content will be automatically added to CHANGELOG.md when this PR is merged."

          gh api repos/${{ github.repository }}/issues/${PR_NUMBER}/comments \
            -X POST -f body="$BODY"
