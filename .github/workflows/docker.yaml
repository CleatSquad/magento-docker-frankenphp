---
name: Build Docker Images
concurrency:
  cancel-in-progress: true
  group: ${{ github.workflow }}-${{ github.ref }}
on:
  push:
    branches:
      - main
    paths:
      - "images/**"
      - ".github/workflows/docker.yaml"
  workflow_dispatch:
    inputs:
      php_versions:
        description: 'PHP versions to build (comma-separated)'
        required: false
        default: '8.2,8.3,8.4'
        type: string
  schedule:
    - cron: "0 4 * * 0"

permissions:
  contents: read

env:
  DOCKERHUB_REPO: mohelmrabet/magento-frankenphp

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      push: ${{ steps.check.outputs.push }}
      php_versions: ${{ steps.matrix.outputs.php_versions }}
      frankenphp_version: ${{ steps.check.outputs.frankenphp_version }}
      image_name: ${{ steps.check.outputs.image_name }}
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Check build conditions
        id: check
        run: |
          # Push if it's a scheduled job, a tag, or if we're committing to the main branch
          if [[ "${GITHUB_EVENT_NAME}" == "schedule" ]] || \
             [[ "${GITHUB_REF}" == refs/tags/* ]] || \
             [[ "${GITHUB_REF}" == "refs/heads/main" && "${GITHUB_EVENT_NAME}" != "pull_request" ]] || \
             [[ "${GITHUB_REF}" == "refs/heads/master" && "${GITHUB_EVENT_NAME}" != "pull_request" ]]; then
            echo "push=true" >> "${GITHUB_OUTPUT}"
            echo "image_name=${{ env.DOCKERHUB_REPO }}" >> "${GITHUB_OUTPUT}"
          else
            echo "push=false" >> "${GITHUB_OUTPUT}"
            echo "image_name=${{ env.DOCKERHUB_REPO }}-dev" >> "${GITHUB_OUTPUT}"
          fi

          # Detect FrankenPHP version from Dockerfile
          DOCKERFILE="images/php/Dockerfile"
          if [ -f "$DOCKERFILE" ]; then
            VERSION=$(grep -oP 'ARG FRANKENPHP_VERSION=\K[0-9]+\.[0-9]+(\.[0-9]+)?' "$DOCKERFILE" | head -1)
            if [ -n "$VERSION" ]; then
              echo "frankenphp_version=${VERSION}" >> "${GITHUB_OUTPUT}"
            else
              echo "frankenphp_version=latest" >> "${GITHUB_OUTPUT}"
            fi
          else
            echo "frankenphp_version=latest" >> "${GITHUB_OUTPUT}"
          fi

      - name: Create PHP versions matrix
        id: matrix
        run: |
          if [[ -n "${INPUT_PHP_VERSIONS}" ]]; then
            # Convert comma-separated to JSON array
            PHP_VERSIONS=$(echo "${INPUT_PHP_VERSIONS}" | sed 's/,/","/g' | sed 's/^/["/' | sed 's/$/"]/')
          else
            PHP_VERSIONS='["8.2","8.3","8.4"]'
          fi
          echo "php_versions=${PHP_VERSIONS}" >> "${GITHUB_OUTPUT}"
        env:
          INPUT_PHP_VERSIONS: ${{ inputs.php_versions }}
  build:
    name: Build & push images
    runs-on: ubuntu-latest
    needs:
      - prepare
    strategy:
      fail-fast: false
      matrix:
        php_version: ${{ fromJson(needs.prepare.outputs.php_versions) }}
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        if: needs.prepare.outputs.push == 'true'
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Generate tags
        id: tags
        run: |
          FP_VERSION="${{ needs.prepare.outputs.frankenphp_version }}"
          PHP_VERSION="${{ matrix.php_version }}"
          IMAGE="${{ needs.prepare.outputs.image_name }}"

          TAGS="${IMAGE}:php${PHP_VERSION}-fp${FP_VERSION}-base"

          # Add latest tag for PHP 8.4 base variant
          if [[ "${PHP_VERSION}" == "8.4" && "${{ needs.prepare.outputs.push }}" == "true" ]]; then
            TAGS="${TAGS},${IMAGE}:latest,${IMAGE}:base"
          fi

          echo "tags=${TAGS}" >> "${GITHUB_OUTPUT}"

      - name: Build and push base images (PHP ${{ matrix.php_version }})
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./images/php/Dockerfile
          target: base
          build-args: |
            PHP_VERSION=${{ matrix.php_version }}
            FRANKENPHP_VERSION=${{ needs.prepare.outputs.frankenphp_version }}
            BUILD_TYPE=base
          push: ${{ needs.prepare.outputs.push == 'true' }}
          load: ${{ needs.prepare.outputs.push != 'true' }}
          tags: ${{ steps.tags.outputs.tags }}
          cache-from: type=gha,scope=base-php${{ matrix.php_version }}-${{ github.ref }}
          cache-to: type=gha,scope=base-php${{ matrix.php_version }}-${{ github.ref }},mode=max,ignore-error=true

      - name: Build and push dev images (PHP ${{ matrix.php_version }})
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./images/php/Dockerfile
          target: dev
          build-args: |
            PHP_VERSION=${{ matrix.php_version }}
            FRANKENPHP_VERSION=${{ needs.prepare.outputs.frankenphp_version }}
            BUILD_TYPE=dev
          push: ${{ needs.prepare.outputs.push == 'true' }}
          load: ${{ needs.prepare.outputs.push != 'true' }}
          tags: ${{ needs.prepare.outputs.image_name }}:php${{ matrix.php_version }}-fp${{ needs.prepare.outputs.frankenphp_version }}-dev
          cache-from: type=gha,scope=dev-php${{ matrix.php_version }}-${{ github.ref }}
          cache-to: type=gha,scope=dev-php${{ matrix.php_version }}-${{ github.ref }},mode=max,ignore-error=true

      - name: Run tests (base)
        if: needs.prepare.outputs.push != 'true'
        run: |
          IMAGE_TAG_BASE="${{ needs.prepare.outputs.image_name }}:php${{ matrix.php_version }}-fp${{ needs.prepare.outputs.frankenphp_version }}-base"
          IMAGE_TAG_DEV="${{ needs.prepare.outputs.image_name }}:php${{ matrix.php_version }}-fp${{ needs.prepare.outputs.frankenphp_version }}-dev"

          echo "üß™ Testing image: ${IMAGE_TAG_BASE}"

          # Test PHP version
          docker run --rm "${IMAGE_TAG_BASE}" php -v | grep -q "PHP ${{ matrix.php_version }}"
          echo "‚úÖ PHP ${{ matrix.php_version }} version verified"

          # Test FrankenPHP
          docker run --rm "${IMAGE_TAG_BASE}" frankenphp version
          echo "‚úÖ FrankenPHP is available"

          # Test Composer
          docker run --rm "${IMAGE_TAG_BASE}" composer --version
          echo "‚úÖ Composer is available"

          # Test required PHP extensions
          EXTENSIONS="bcmath gd intl mbstring opcache pdo_mysql soap xsl zip sockets sodium"
          for ext in $EXTENSIONS; do
            if docker run --rm "${IMAGE_TAG_BASE}" php -m | grep -qi "$ext"; then
              echo "‚úÖ Extension $ext is installed"
            else
              echo "‚ùå Extension $ext is missing"
              exit 1
            fi
          done

          echo "üß™ Testing image: ${IMAGE_TAG_DEV}"

          # Test PHP version
          docker run --rm "${IMAGE_TAG_DEV}" php -v | grep -q "PHP ${{ matrix.php_version }}"
          echo "‚úÖ PHP ${{ matrix.php_version }} version verified"

          # Test FrankenPHP
          docker run --rm "${IMAGE_TAG_DEV}" frankenphp version
          echo "‚úÖ FrankenPHP is available"

          # Test Composer
          docker run --rm "${IMAGE_TAG_DEV}" composer --version
          echo "‚úÖ Composer is available"

          # Test required PHP extensions
          EXTENSIONS="bcmath gd intl mbstring opcache pdo_mysql soap xsl zip sockets sodium"
          for ext in $EXTENSIONS; do
            if docker run --rm "${IMAGE_TAG_DEV}" php -m | grep -qi "$ext"; then
              echo "‚úÖ Extension $ext is installed"
            else
              echo "‚ùå Extension $ext is missing"
              exit 1
            fi
          done

  push-readme:
    name: Push README to Docker Hub
    runs-on: ubuntu-latest
    needs:
      - prepare
      - build
    if: needs.prepare.outputs.push == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Push README to Docker Hub
        uses: peter-evans/dockerhub-description@v4
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          repository: ${{ env.DOCKERHUB_REPO }}
          readme-filepath: ./DOCKER_README.md
          short-description: "Magento 2 + FrankenPHP Docker Images"
