---
name: Cleanup (On-demand)

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  statuses: write

jobs:
  check-command:
    name: Check Command
    runs-on: ubuntu-latest
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '@bot cleanup')
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      pr_number: ${{ github.event.issue.number }}
      pr_sha: ${{ steps.get-pr.outputs.sha }}
      comment_id: ${{ github.event.comment.id }}
    steps:
      - name: Check if command is valid
        id: check
        run: echo "should_run=true" >> "$GITHUB_OUTPUT"

      - name: Get PR SHA
        id: get-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_SHA=$(gh api repos/${{ github.repository }}/pulls/${{ github.event.issue.number }} --jq '.head.sha')
          echo "sha=$PR_SHA" >> "$GITHUB_OUTPUT"

      - name: React to comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions \
            -X POST -f content='rocket'

  cleanup:
    name: Cleanup Resources
    runs-on: ubuntu-latest
    needs: check-command
    if: needs.check-command.outputs.should_run == 'true'
    steps:
      - name: Set pending status
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/statuses/${{ needs.check-command.outputs.pr_sha }} \
            -X POST \
            -f state='pending' \
            -f context='Cleanup (On-demand)' \
            -f description='Cleaning up CI resources...' \
            -f target_url='${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'

      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ needs.check-command.outputs.pr_number }}/head
          persist-credentials: false

      - name: Get initial disk usage
        id: disk_before
        run: |
          DISK_USED=$(df -h / | awk 'NR==2 {print $3}')
          echo "used=$DISK_USED" >> "$GITHUB_OUTPUT"

      - name: Stop all running containers
        id: stop_containers
        run: |
          RUNNING=$(docker ps -q | wc -l)
          if [ "$RUNNING" -gt 0 ]; then
            docker stop $(docker ps -q) || true
          fi
          echo "stopped=$RUNNING" >> "$GITHUB_OUTPUT"

      - name: Remove all containers
        id: remove_containers
        run: |
          CONTAINERS=$(docker ps -aq | wc -l)
          if [ "$CONTAINERS" -gt 0 ]; then
            docker rm -f $(docker ps -aq) || true
          fi
          echo "removed=$CONTAINERS" >> "$GITHUB_OUTPUT"

      - name: Remove orphan volumes
        id: remove_volumes
        run: |
          VOLUMES=$(docker volume ls -q | wc -l)
          docker volume prune -f || true
          echo "cleaned=$VOLUMES" >> "$GITHUB_OUTPUT"

      - name: Remove dangling images
        id: remove_images
        run: |
          DANGLING=$(docker images -f "dangling=true" -q | wc -l)
          docker image prune -f || true
          echo "removed=$DANGLING" >> "$GITHUB_OUTPUT"

      - name: Remove unused networks
        id: remove_networks
        run: |
          docker network prune -f || true
          echo "cleaned=true" >> "$GITHUB_OUTPUT"

      - name: Remove build cache
        id: remove_cache
        run: |
          CACHE_SIZE=$(docker system df --format '{{.BuildCache}}' | head -1 || echo "0B")
          docker builder prune -f || true
          echo "freed=$CACHE_SIZE" >> "$GITHUB_OUTPUT"

      - name: Full system prune
        id: system_prune
        run: |
          docker system prune -af --volumes || true
          echo "complete=true" >> "$GITHUB_OUTPUT"

      - name: Get final disk usage
        id: disk_after
        run: |
          DISK_USED=$(df -h / | awk 'NR==2 {print $3}')
          echo "used=$DISK_USED" >> "$GITHUB_OUTPUT"

      - name: Post results comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          STOPPED: ${{ steps.stop_containers.outputs.stopped }}
          REMOVED_CONTAINERS: ${{ steps.remove_containers.outputs.removed }}
          CLEANED_VOLUMES: ${{ steps.remove_volumes.outputs.cleaned }}
          REMOVED_IMAGES: ${{ steps.remove_images.outputs.removed }}
          DISK_BEFORE: ${{ steps.disk_before.outputs.used }}
          DISK_AFTER: ${{ steps.disk_after.outputs.used }}
        run: |
          BODY="## Cleanup Results

          ### Actions Performed
          | Action | Count/Status |
          |--------|--------------|
          | Containers stopped | ${STOPPED} |
          | Containers removed | ${REMOVED_CONTAINERS} |
          | Volumes cleaned | ${CLEANED_VOLUMES} |
          | Dangling images removed | ${REMOVED_IMAGES} |
          | Networks pruned | Done |
          | Build cache cleared | Done |
          | Full system prune | Done |

          ### Disk Usage
          | Metric | Value |
          |--------|-------|
          | Before cleanup | ${DISK_BEFORE} |
          | After cleanup | ${DISK_AFTER} |

          [View full logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

          gh api repos/${{ github.repository }}/issues/${{ needs.check-command.outputs.pr_number }}/comments \
            -X POST -f body="$BODY"

      - name: Set final status
        id: final_status
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          STATE="success"
          DESC="Cleanup complete"
          echo "state=$STATE" >> "$GITHUB_OUTPUT"
          gh api repos/${{ github.repository }}/statuses/${{ needs.check-command.outputs.pr_sha }} \
            -X POST \
            -f state="$STATE" \
            -f context='Cleanup (On-demand)' \
            -f description="$DESC" \
            -f target_url='${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'

      - name: Add success reaction
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/comments/${{ needs.check-command.outputs.comment_id }}/reactions \
            -X POST -f content='+1'
