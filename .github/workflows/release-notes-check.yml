---
name: Release Notes Check

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]
    branches:
      - main

permissions:
  contents: read
  pull-requests: write
  statuses: write

jobs:
  check-release-notes:
    name: Check Release Notes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          persist-credentials: false

      - name: Check for release notes
        id: check
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_LABELS: ${{ join(github.event.pull_request.labels.*.name, ',') }}
        run: |
          NOTES_FILE=".release-notes/pr-${PR_NUMBER}.md"

          # Check if skip label is present
          if echo "$PR_LABELS" | grep -qiE 'skip-release-notes|no-release-notes|documentation'; then
            echo "status=skip" >> "$GITHUB_OUTPUT"
            echo "Release notes not required (skip label present)"
            exit 0
          fi

          # Check if release notes file exists
          if [ -f "$NOTES_FILE" ]; then
            # Check if file has content (not just whitespace or comments)
            CONTENT=$(grep -v "^#" "$NOTES_FILE" | grep -v "^<!--" | grep -v -- "-->" | tr -d '[:space:]')
            if [ -n "$CONTENT" ]; then
              echo "status=found" >> "$GITHUB_OUTPUT"
              echo "Release notes found: $NOTES_FILE"
            else
              echo "status=empty" >> "$GITHUB_OUTPUT"
              echo "Release notes file exists but is empty"
            fi
          else
            echo "status=missing" >> "$GITHUB_OUTPUT"
            echo "Release notes file not found: $NOTES_FILE"
          fi

      - name: Set commit status
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          STATUS: ${{ steps.check.outputs.status }}
          PR_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          case "$STATUS" in
            found|skip)
              STATE="success"
              DESC="Release notes ready"
              ;;
            empty)
              STATE="failure"
              DESC="Release notes file is empty"
              ;;
            missing)
              STATE="failure"
              DESC="Release notes missing - use @bot generate-release-note"
              ;;
            *)
              STATE="error"
              DESC="Could not check release notes"
              ;;
          esac

          gh api repos/${{ github.repository }}/statuses/${PR_SHA} \
            -X POST \
            -f state="$STATE" \
            -f context='Release Notes' \
            -f description="$DESC" \
            -f target_url='${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'

      - name: Comment if missing
        if: steps.check.outputs.status == 'missing' || steps.check.outputs.status == 'empty'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          STATUS: ${{ steps.check.outputs.status }}
        run: |
          # Check if we already commented recently
          EXISTING=$(gh api repos/${{ github.repository }}/issues/${PR_NUMBER}/comments \
            --jq '.[] | select(.user.login == "github-actions[bot]") | select(.body | contains("Release notes are required")) | .id' \
            | tail -1)

          if [ -n "$EXISTING" ]; then
            echo "Already commented about release notes"
            exit 0
          fi

          if [ "$STATUS" = "empty" ]; then
            MSG="⚠️ **Release notes file exists but is empty.**"
          else
            MSG="⚠️ **Release notes are required before merging.**"
          fi

          BODY="${MSG}

          Please create release notes using one of these methods:

          1. **Automatic:** Comment \`@bot generate-release-note\` on this PR
          2. **Manual:** Create \`.release-notes/pr-${PR_NUMBER}.md\` with your changes

          If this PR doesn't need release notes (e.g., documentation only), add the \`skip-release-notes\` label."

          gh api repos/${{ github.repository }}/issues/${PR_NUMBER}/comments \
            -X POST -f body="$BODY"
