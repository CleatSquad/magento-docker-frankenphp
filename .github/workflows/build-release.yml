name: Build and Release Docker Images

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - build
          - push
          - release
          - list
      php_versions:
        description: 'PHP versions to build (comma-separated, e.g., 8.2,8.3,8.4)'
        required: false
        default: '8.2,8.3,8.4'

env:
  IMAGE: mohelmrabet/magento-frankenphp
  FRANKENPHP_VERSION: '1.10'

permissions:
  contents: read

jobs:
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    if: ${{ inputs.action == 'build' || inputs.action == 'release' }}
    strategy:
      matrix:
        php_version: ${{ fromJson(format('["{0}"]', join(fromJson(format('["{0}"]', inputs.php_versions)), '","'))) }}
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build base image (PHP ${{ matrix.php_version }})
        run: |
          echo "ðŸ”¨ Building PHP ${{ matrix.php_version }} BASE..."
          docker build \
            -f images/php/${{ matrix.php_version }}/base/Dockerfile \
            -t ${{ env.IMAGE }}:php${{ matrix.php_version }}-fp${{ env.FRANKENPHP_VERSION }}-base \
            .
          echo "âœ… PHP ${{ matrix.php_version }} BASE built!"

      - name: Build dev image (PHP ${{ matrix.php_version }})
        run: |
          echo "ðŸ”¨ Building PHP ${{ matrix.php_version }} DEV..."
          docker build \
            -f images/php/${{ matrix.php_version }}/dev/Dockerfile \
            -t ${{ env.IMAGE }}:php${{ matrix.php_version }}-fp${{ env.FRANKENPHP_VERSION }}-dev \
            .
          echo "âœ… PHP ${{ matrix.php_version }} DEV built!"

      - name: List built images
        run: |
          echo "ðŸ“¦ Built images:"
          docker images | grep ${{ env.IMAGE }}

  push:
    name: Push Docker Images
    runs-on: ubuntu-latest
    if: ${{ inputs.action == 'push' || inputs.action == 'release' }}
    needs: [build]
    strategy:
      matrix:
        php_version: ${{ fromJson(format('["{0}"]', join(fromJson(format('["{0}"]', inputs.php_versions)), '","'))) }}
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push base image (PHP ${{ matrix.php_version }})
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./images/php/${{ matrix.php_version }}/base/Dockerfile
          push: true
          tags: ${{ env.IMAGE }}:php${{ matrix.php_version }}-fp${{ env.FRANKENPHP_VERSION }}-base
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push dev image (PHP ${{ matrix.php_version }})
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./images/php/${{ matrix.php_version }}/dev/Dockerfile
          push: true
          tags: ${{ env.IMAGE }}:php${{ matrix.php_version }}-fp${{ env.FRANKENPHP_VERSION }}-dev
          cache-from: type=gha
          cache-to: type=gha,mode=max

  push-latest:
    name: Push Latest Tags
    runs-on: ubuntu-latest
    if: ${{ inputs.action == 'release' }}
    needs: [push]
    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Tag and push latest
        run: |
          echo "ðŸ“¤ Pushing latest tags..."

          # Pull PHP 8.4 images to tag as latest
          docker pull ${{ env.IMAGE }}:php8.4-fp${{ env.FRANKENPHP_VERSION }}-base
          docker pull ${{ env.IMAGE }}:php8.4-fp${{ env.FRANKENPHP_VERSION }}-dev

          # Tag as latest/base/dev
          docker tag ${{ env.IMAGE }}:php8.4-fp${{ env.FRANKENPHP_VERSION }}-base ${{ env.IMAGE }}:latest
          docker tag ${{ env.IMAGE }}:php8.4-fp${{ env.FRANKENPHP_VERSION }}-base ${{ env.IMAGE }}:base
          docker tag ${{ env.IMAGE }}:php8.4-fp${{ env.FRANKENPHP_VERSION }}-dev ${{ env.IMAGE }}:dev

          # Push tags
          docker push ${{ env.IMAGE }}:latest
          docker push ${{ env.IMAGE }}:base
          docker push ${{ env.IMAGE }}:dev

          echo "âœ… Latest tags pushed!"

  push-readme:
    name: Push README to Docker Hub
    runs-on: ubuntu-latest
    if: ${{ inputs.action == 'release' }}
    needs: [push-latest]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Push README to Docker Hub
        uses: peter-evans/dockerhub-description@v4
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          repository: mohelmrabet/magento-frankenphp
          readme-filepath: ./DOCKER_README.md
          short-description: "Magento 2 + FrankenPHP Docker Images"

  list:
    name: List Docker Images
    runs-on: ubuntu-latest
    if: ${{ inputs.action == 'list' }}
    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: List images on Docker Hub
        run: |
          echo "ðŸ“¦ Images on Docker Hub:"
          echo ""
          echo "Available tags for ${{ env.IMAGE }}:"
          curl -s "https://hub.docker.com/v2/repositories/${{ env.IMAGE }}/tags?page_size=100" | \
            jq -r '.results[] | "\(.name) - \(.last_updated)"' | sort
