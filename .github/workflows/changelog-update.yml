---
name: Update CHANGELOG on PR merge

on:
  pull_request:
    types: [closed]

permissions:
  contents: write
  pull-requests: write

jobs:
  update-changelog:
    name: Update CHANGELOG
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Check for release notes file
        id: check_notes
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          NOTES_FILE=".release-notes/pr-${PR_NUMBER}.md"

          if [ -f "$NOTES_FILE" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "file=$NOTES_FILE" >> $GITHUB_OUTPUT
            echo "Release notes found: $NOTES_FILE"
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "No release notes file found for PR #${PR_NUMBER}"
          fi

      - name: Update CHANGELOG.md
        if: steps.check_notes.outputs.found == 'true'
        run: |
          NOTES_FILE="${{ steps.check_notes.outputs.file }}"
          PR_NUMBER=${{ github.event.pull_request.number }}
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_URL="${{ github.event.pull_request.html_url }}"

          # Read release notes content (skip comment lines)
          RELEASE_CONTENT=$(grep -v "^<!--" "$NOTES_FILE" | grep -v "^-->" | grep -v "^Example:" | sed '/^$/N;/^\n$/d')

          if [ -z "$RELEASE_CONTENT" ]; then
            echo "Release notes file is empty or contains only comments"
            exit 0
          fi

          # Check if [Unreleased] section exists
          if ! grep -q "## \[Unreleased\]" CHANGELOG.md; then
            # Add [Unreleased] section after the header
            HEADER_END=$(grep -n "^##" CHANGELOG.md | head -1 | cut -d: -f1)
            if [ -z "$HEADER_END" ]; then
              # No sections yet, add after line 7 (after header comments)
              {
                head -n 7 CHANGELOG.md
                echo ""
                echo "## [Unreleased]"
                echo ""
                tail -n +8 CHANGELOG.md
              } > CHANGELOG.tmp
            else
              # Add before first section
              {
                head -n $((HEADER_END - 1)) CHANGELOG.md
                echo "## [Unreleased]"
                echo ""
                tail -n +$HEADER_END CHANGELOG.md
              } > CHANGELOG.tmp
            fi
            mv CHANGELOG.tmp CHANGELOG.md
          fi

          # Find [Unreleased] line
          UNRELEASED_LINE=$(grep -n "## \[Unreleased\]" CHANGELOG.md | head -1 | cut -d: -f1)

          # Insert release notes after [Unreleased]
          {
            head -n $UNRELEASED_LINE CHANGELOG.md
            echo ""
            echo "$RELEASE_CONTENT"
            echo ""
            echo "_From PR #${PR_NUMBER}: ${PR_TITLE}_"
            tail -n +$((UNRELEASED_LINE + 1)) CHANGELOG.md
          } > CHANGELOG.tmp
          mv CHANGELOG.tmp CHANGELOG.md

          echo "CHANGELOG.md updated with release notes from PR #${PR_NUMBER}"

      - name: Remove release notes file
        if: steps.check_notes.outputs.found == 'true'
        run: |
          NOTES_FILE="${{ steps.check_notes.outputs.file }}"
          rm -f "$NOTES_FILE"

          # Remove .release-notes directory if empty
          if [ -d ".release-notes" ] && [ -z "$(ls -A .release-notes)" ]; then
            rmdir .release-notes
          fi

      - name: Create PR for CHANGELOG update
        if: steps.check_notes.outputs.found == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if there are changes to commit
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          BRANCH_NAME="changelog/pr-${PR_NUMBER}"

          # Check if PR already exists for this branch
          EXISTING_PR=$(gh pr list --head "$BRANCH_NAME" --state open --json number --jq '.[0].number' 2>/dev/null || echo "")
          if [ -n "$EXISTING_PR" ]; then
            echo "PR #${EXISTING_PR} already exists for branch ${BRANCH_NAME}. Skipping."
            exit 0
          fi

          # Delete remote branch if it exists (from a previous failed run)
          git push origin --delete "$BRANCH_NAME" 2>/dev/null || true

          # Create branch and commit
          git checkout -b "$BRANCH_NAME"
          git commit -m "docs: Update CHANGELOG from PR #${PR_NUMBER}"
          git push origin "$BRANCH_NAME"

          # Create PR body using here-document
          PR_BODY=$(cat <<EOF
          Automated CHANGELOG update from merged PR #${PR_NUMBER}.

          This PR was automatically created when PR #${PR_NUMBER} was merged.
          EOF
          )

          # Create PR
          gh pr create \
            --title "docs: Update CHANGELOG from PR #${PR_NUMBER}" \
            --body "$PR_BODY" \
            --base main \
            --head "$BRANCH_NAME" \
            --label "skip-release-notes"
