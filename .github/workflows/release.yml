name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "date=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT

      - name: Extract release notes from CHANGELOG
        id: release_notes
        run: |
          UNRELEASED_START=$(grep -n "## \[Unreleased\]" CHANGELOG.md | head -1 | cut -d: -f1)
          NEXT_VERSION_LINE=$(tail -n +$((UNRELEASED_START + 1)) CHANGELOG.md | grep -n "^## \[v" | head -1 | cut -d: -f1)
          if [ -n "$NEXT_VERSION_LINE" ]; then
            NEXT_VERSION_LINE=$((UNRELEASED_START + NEXT_VERSION_LINE - 1))
            sed -n "$((UNRELEASED_START + 1)),$((NEXT_VERSION_LINE - 1))p" CHANGELOG.md | sed '/^$/d' > release_notes.md
          else
            LINKS_START=$(grep -n "^\[Unreleased\]:" CHANGELOG.md | head -1 | cut -d: -f1)
            if [ -n "$LINKS_START" ]; then
              sed -n "$((UNRELEASED_START + 1)),$((LINKS_START - 1))p" CHANGELOG.md | sed '/^$/d' > release_notes.md
            else
              tail -n +$((UNRELEASED_START + 1)) CHANGELOG.md > release_notes.md
            fi
          fi
          echo "Extracted release notes:"
          cat release_notes.md

      - name: Update CHANGELOG.md
        run: |
          VERSION=${{ steps.version.outputs.version }}
          DATE=${{ steps.version.outputs.date }}
          if ! grep -q "## \[$VERSION\]" CHANGELOG.md; then
            UNRELEASED_LINE=$(grep -n "## \[Unreleased\]" CHANGELOG.md | head -1 | cut -d: -f1)
            NEXT_VERSION_LINE=$(tail -n +$((UNRELEASED_LINE + 1)) CHANGELOG.md | grep -n "^## \[v" | head -1 | cut -d: -f1)
            if [ -n "$NEXT_VERSION_LINE" ]; then
              NEXT_VERSION_LINE=$((UNRELEASED_LINE + NEXT_VERSION_LINE))
            fi
            {
              head -n $UNRELEASED_LINE CHANGELOG.md
              echo ""
              echo "## [$VERSION] - $DATE"
              tail -n +$((UNRELEASED_LINE + 1)) CHANGELOG.md
            } > CHANGELOG.tmp
            mv CHANGELOG.tmp CHANGELOG.md
            if grep -q "^\[Unreleased\]:" CHANGELOG.md; then
              sed -i "s|\[Unreleased\]:.*|\[Unreleased\]: https://github.com/CleatSquad/magento-frankenphp-template/compare/$VERSION...HEAD|" CHANGELOG.md
              if ! grep -q "^\[$VERSION\]:" CHANGELOG.md; then
                PREV_VERSION=$(grep -o "\[v[0-9.]*\]:" CHANGELOG.md | head -1 | tr -d '[]:'  )
                if [ -n "$PREV_VERSION" ]; then
                  sed -i "/^\[Unreleased\]:/a [$VERSION]: https://github.com/CleatSquad/magento-frankenphp-template/compare/$PREV_VERSION...$VERSION" CHANGELOG.md
                fi
              fi
            fi
          fi

      - name: Create Pull Request for changelog update
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "docs: Update CHANGELOG for ${{ steps.version.outputs.version }}"
          branch: "chore/changelog-update-${{ steps.version.outputs.version }}"
          title: "docs: Update CHANGELOG for ${{ steps.version.outputs.version }}"
          body: |
            Cette PR met à jour le CHANGELOG suite à la release `${{ steps.version.outputs.version }}`.
            _Merge cette PR pour intégrer la mise à jour dans main._
          labels: |
            release
          base: main
          delete-branch: true
          token: ${{ secrets.GITHUB_TOKEN }}
          add-paths: CHANGELOG.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(github.ref, '-alpha') || contains(github.ref, '-beta') || contains(github.ref, '-rc') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
