---
name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "date=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT

      - name: Extract release notes from CHANGELOG
        id: release_notes
        run: |
          # Extract content between [Unreleased] and the next version header
          UNRELEASED_START=$(grep -n "## \[Unreleased\]" CHANGELOG.md | head -1 | cut -d: -f1)
          NEXT_VERSION_LINE=$(tail -n +$((UNRELEASED_START + 1)) CHANGELOG.md | grep -n "^## \[v" | head -1 | cut -d: -f1)

          if [ -n "$NEXT_VERSION_LINE" ]; then
            # Extract lines between [Unreleased] and next version
            NEXT_VERSION_LINE=$((UNRELEASED_START + NEXT_VERSION_LINE - 1))
            sed -n "$((UNRELEASED_START + 1)),$((NEXT_VERSION_LINE - 1))p" CHANGELOG.md | sed '/^$/d' > release_notes.md
          else
            # No previous version, extract until end of file (excluding links section)
            LINKS_START=$(grep -n "^\[Unreleased\]:" CHANGELOG.md | head -1 | cut -d: -f1)
            if [ -n "$LINKS_START" ]; then
              sed -n "$((UNRELEASED_START + 1)),$((LINKS_START - 1))p" CHANGELOG.md | sed '/^$/d' > release_notes.md
            else
              tail -n +$((UNRELEASED_START + 1)) CHANGELOG.md > release_notes.md
            fi
          fi

          # Show what was extracted
          echo "Extracted release notes:"
          cat release_notes.md

      - name: Update CHANGELOG.md
        id: update_changelog
        run: |
          VERSION=${{ steps.version.outputs.version }}
          DATE=${{ steps.version.outputs.date }}

          # Check if version already exists in changelog
          if ! grep -q "## \[$VERSION\]" CHANGELOG.md; then
            # Find the [Unreleased] line and replace it while keeping empty section
            UNRELEASED_LINE=$(grep -n "## \[Unreleased\]" CHANGELOG.md | head -1 | cut -d: -f1)
            NEXT_VERSION_LINE=$(tail -n +$((UNRELEASED_LINE + 1)) CHANGELOG.md | grep -n "^## \[v" | head -1 | cut -d: -f1)

            if [ -n "$NEXT_VERSION_LINE" ]; then
              NEXT_VERSION_LINE=$((UNRELEASED_LINE + NEXT_VERSION_LINE))
            fi

            # Create updated changelog
            {
              # Keep header until [Unreleased]
              head -n $UNRELEASED_LINE CHANGELOG.md
              echo ""
              # Add new version header with the content that was under [Unreleased]
              echo "## [$VERSION] - $DATE"
              # Keep everything from after [Unreleased] onwards
              tail -n +$((UNRELEASED_LINE + 1)) CHANGELOG.md
            } > CHANGELOG.tmp
            mv CHANGELOG.tmp CHANGELOG.md

            # Update links at the bottom
            if grep -q "^\[Unreleased\]:" CHANGELOG.md; then
              # Update Unreleased link to compare with new version
              sed -i "s|\[Unreleased\]:.*|\[Unreleased\]: https://github.com/${{ github.repository }}/compare/$VERSION...HEAD|" CHANGELOG.md
              # Add new version link if not exists
              if ! grep -q "^\[$VERSION\]:" CHANGELOG.md; then
                PREV_VERSION=$(grep -o "\[v[0-9.]*\]:" CHANGELOG.md | head -1 | tr -d '[]:'  )
                if [ -n "$PREV_VERSION" ]; then
                  sed -i "/^\[Unreleased\]:/a [$VERSION]: https://github.com/${{ github.repository }}/compare/$PREV_VERSION...$VERSION" CHANGELOG.md
                fi
              fi
            fi
            echo "updated=true" >> $GITHUB_OUTPUT
          else
            echo "updated=false" >> $GITHUB_OUTPUT
          fi

      - name: Create PR for CHANGELOG update
        if: steps.update_changelog.outputs.updated == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          BRANCH_NAME="release/changelog-${VERSION}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create branch and commit
          git checkout -b "$BRANCH_NAME"
          git add CHANGELOG.md
          git commit -m "docs: Update CHANGELOG for ${VERSION}"
          git push origin "$BRANCH_NAME"

          # Create PR
          gh pr create \
            --title "docs: Update CHANGELOG for ${VERSION}" \
            --body "Automated CHANGELOG update for release ${VERSION}.

          This PR updates the CHANGELOG.md to mark the release.

          **Auto-merge:** This PR can be merged automatically." \
            --base main \
            --head "$BRANCH_NAME" \
            --label "skip-release-notes"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(github.ref, '-alpha') || contains(github.ref, '-beta') || contains(github.ref, '-rc') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
