---
name: Cleanup Caches

on:
  workflow_dispatch:

permissions:
  actions: write

jobs:
  cleanup:
    name: Delete all caches
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Cleanup caches
        run: |
          echo "üßπ Starting cache cleanup..."

          set +e
          while true; do
            # Fetch caches in batches
            cacheKeys=$(gh cache list --limit 100 --json key --jq '.[].key')

            if [ -z "$cacheKeys" ]; then
              echo "No more caches to delete."
              break
            fi

            echo "üóëÔ∏è Deleting batch of caches..."
            for cacheKey in $cacheKeys
            do
              echo "Deleting cache: $cacheKey"
              gh cache delete "$cacheKey" || echo "Failed to delete cache $cacheKey"
            done
          done
          set -e

          echo "‚úÖ Cache cleanup completed!"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
